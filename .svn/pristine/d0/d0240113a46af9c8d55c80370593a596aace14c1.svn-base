package models

import (
	"crypto/md5"
	"fmt"
	"github.com/astaxie/beego"
	"github.com/astaxie/beego/orm"
	_ "github.com/go-sql-driver/mysql"
	"net/url"
	"strings"
	"strconv"
	"app/common/conndatabase"
)


func init() {
	dbhost := beego.AppConfig.String("dbhost")
	dbport := beego.AppConfig.String("dbport")
	dbuser := beego.AppConfig.String("dbuser")
	dbpassword := beego.AppConfig.String("dbpassword")
	dbname := beego.AppConfig.String("dbname")
	dbprefix := beego.AppConfig.String("dbprefix")
	if dbport == "" {
		dbport = "3306"
	}
	dburl := dbuser + ":" + dbpassword + "@tcp(" + dbhost + ":" + dbport + ")/" + dbname + "?charset=utf8"
	orm.RegisterDataBase("default", "mysql", dburl,30,30)
	/*
	beego必须注册一个别名为default的数据库，作为默认使用。
	orm.RegisterDataBase("default", "mysql", "test:123456@/test?charset=utf8",30,30)
	第一个参数是数据库的别名，用来切换数据库使用。
	第二个是driverName，在RegisterDriver时注册的
    第三是数据库连接字符串:test:123456@/test?charset=utf8相对于用户名:密码@数据库地址+名称?字符集
    第四个参数相当于:
	orm.SetMaxIdleConns("default", 30)
	设置数据库的最大空闲连接。
	第五个参数相当于：
	orm.SetMaxOpenConns("default", 30)
	设置数据库的最大数据库连接。
	第四个参数和第五个参数也可以不传值，会使用数据库默认值
	*/
	orm.RegisterModelWithPrefix(dbprefix,new(User))
	if beego.AppConfig.String("runmode") == "dev" {
		orm.Debug = true
		// 自动建表
		//orm.RunSyncdb("default", false, true)
	}
	DbInit()
}


func Md5(buf []byte) string {
	hash := md5.New()
	hash.Write(buf)
	return fmt.Sprintf("%x", hash.Sum(nil))
}

func Rawurlencode(str string) string {
	return strings.Replace(url.QueryEscape(str), "+", "%20", -1)
}

//返回带前缀的表名
func TableName(str string) string {
	return fmt.Sprintf("%s%s", beego.AppConfig.String("dbprefix"), str)
}

func  Insert(m interface{}) error {
	if _, err := orm.NewOrm().Insert(m); err != nil {
		return err
	}
	return nil
}

func  Read(m interface{},fields ...string) error {
	if err := orm.NewOrm().Read(m, fields...); err != nil {
		return err
	}
	return nil
}

func  Update(m interface{},fields ...string) error {
	if _, err := orm.NewOrm().Update(m, fields...); err != nil {
		return err
	}
	return nil
}

func  Delete(m interface{}) error {
	if _, err := orm.NewOrm().Delete(m); err != nil {
		return err
	}
	return nil
}

func  Query(m interface{}) orm.QuerySeter {
	return orm.NewOrm().QueryTable(m)
}


/**
 * 分页函数，适用任何表
 * 返回 总记录条数,总页数,以及当前请求的数据RawSeter,调用中需要"rs.QueryRows(&tblog)"就行了  --tblog是一个Tb_log对象
 * 参数：表名，当前页数，页面大小，条件（查询条件,格式为 " and name='zhifeiya' and age=12 "）
 *
	start, _ := this.GetInt("start") //获取起始位置
	length, _ := this.GetInt("length") //获取分页步长
	draw, _ := this.GetInt("draw") //获取请求次数
	var user []models.User
	var conditions string = " order by userid desc"
	var  TableName = "lb_users"
	totalItem, rs :=models.GetPagesInfo(TableName,start,length,conditions)
	rs.QueryRows(&user)
	Json := map[string]interface{}{"draw":draw,"recordsTotal": totalItem,"recordsFiltered":totalItem,"data":user}
	this.renderJson(Json)

 */
func GetPagesInfo(tableName string, start int, pagesize int, conditions string) (int, orm.RawSeter) {
	if start <= 1 {
		start = 1
	}
	if pagesize == 0 {
		pagesize = 15
	}
	var rs orm.RawSeter
	o := orm.NewOrm()
	var totalItem  int = 0                                                          //总条数
	o.Raw("SELECT count(*) FROM " + tableName + "  where true " + conditions).QueryRow(&totalItem) //获取总条数
	rs = o.Raw("select *  from  " + tableName + "  where true " + conditions + " LIMIT " + strconv.Itoa(start) + "," + strconv.Itoa(pagesize))
	return totalItem,  rs
}

//获取ID主键
func GetID() int64{
	IdWorker,err := conndatabase.NewIdWorker(1,1)
	if err != nil{
		fmt.Println(nil)
	}
	id,error :=  IdWorker.NextId()
	if error != nil{
		fmt.Println(nil)
	}
	if id < 0{
		id = 0-id
	}
	return id
}



func  DbInit(){
	var sqlMap map[string]string
	sqlMap = make(map[string]string)
	sqlMap["user"] = `
	create table if not exists lb_user
    (
		userid bigint(20) not null  comment '用户id',
		openid char(20) not null  default ''  comment 'openid',
		wnickname char(30) not null  default ''  comment '微信昵称',
		wimgurl char(150) not null  default ''  comment '微信头像',
		nickname char(30) not null  default ''  comment '用户名',
		imgurl char(100) not null  default ''  comment '头像',
		regtime int (11) not null  default '0'  comment '注册时间',
		gender char(1) not null  default '0' comment '性别',
		age   char(5) not null default '0'  comment '年龄',
		telphone int(11) null  default '0'  comment '电话',
		qq char(20) not null  default ''  comment 'QQ号',
		weino char(20) not null default '' comment '微博号',
		signature  char(150) not null default '' comment '签名',
		address char(255) not null default '' comment '地址',
		created_at int (11) not null  default '0'  comment '注册时间',
	    updated_at int (11) not null  default '0'  comment '修改时间',
		primary key (userid)
    )engine=InnoDB default charset=utf8 comment='用户表';
    `
	sqlMap["concern"] = `
	create table  if not exists lb_concern
	(
		userid bigint(20) not null,
		books json,
		primary key (userid)
	)engine=InnoDB default charset=utf8 comment='收藏表';
	`
	sqlMap["bookrack"] = `
	create table if not exists lb_bookrack
	(
		userid bigint(20) not null comment '用户id',
		books json comment 'bookid:图书编号,bookname:书名,author:作者,imgurl:书本组图,describe:简介,state:图书状态,flag:图书标签,create_time:上架时间',
		update_time int(11) not null default '0' comment '修改时间',
		primary key (userid)
	)engine=InnoDB default charset=utf8 comment='书架表';
	`
	sqlMap["books"] = `
	create table if not exists lb_books
	(
		bookid bigint(20) not null  comment '图书编号',
		bookname char(50) not null default ''  comment '书名',
		author char(20) not null default ''  comment '作者',
		imgurl char(150) not null default ''  comment '图书封面图',
		imgheadurl char(150) not null default ''  comment '图书正面图',
		imgbackurl char(150) not null default ''  comment '图书背面图',
		isbn char(18) not null default '',
		depreciation float(2) not null default '0.00',
		price float(4) not null default '0.00' comment '标价',
		describe  text  comment'图书简介',
		state tinyint(1) not null default '1' comment '状态',
		primary key (bookid)
	)engine=InnoDB default charset=utf8 comment='图书表';
	`
	sqlMap["bookorder"] = `
	create table if not exists lb_bookorder
	(
		orderid bigint(20) not null comment '订单编号',
		userid_from_confirm int(11) not null default '0'  comment '书主人编号',
		userid_to_confrim int(11) not null  default '0'  comment '借书人编号',
		books json comment 'bookid:图书编号,bookname:书名,author:作者,imgurl:书本组图,describe:简介,state:图书状态,flag:图书标签,create_time:上架时间',
		users json comment 'from:书主人信息,to:借阅者信息',
		order_state tyint(1) not null  default '0'  comment '状态1:接收2:拒绝,3:完成',
		primary key (orderid)
	)engine=InnoDB default charset=utf8 comment='订单表';
	`
	sqlMap["loginlog"] = `
	create table if not exists lb_loginlog
	(
		userid bigint(20) not null,
		logintime int (11) not null  default '0'  comment '登录时间',
		primary key (userid)
	)engine=InnoDB default charset=utf8 comment='登录时间表';
	`
	o := orm.NewOrm()
	for _,v := range sqlMap {
		res, err := o.Raw(v).Exec()
		if err == nil {
			num, _ := res.RowsAffected()
			fmt.Println("mysql row affected nums: ", num)
		}
	}

}
